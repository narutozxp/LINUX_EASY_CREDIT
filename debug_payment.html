<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ”¯ä»˜æ¥å£è°ƒè¯•å·¥å…·</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        .header p {
            opacity: 0.9;
            font-size: 14px;
        }
        .content {
            padding: 30px;
        }
        .section {
            margin: 25px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        .section h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 18px;
        }
        .info-box {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
            border-left: 4px solid #2196F3;
        }
        .warning-box {
            background: #fff3e0;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
            border-left: 4px solid #ff9800;
        }
        .success-box {
            background: #e8f5e9;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
            border-left: 4px solid #4caf50;
        }
        .error-box {
            background: #ffebee;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
            border-left: 4px solid #f44336;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 14px 28px;
            font-size: 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            font-weight: 600;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        button:active {
            transform: translateY(0);
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        .code-block {
            background: #263238;
            color: #aed581;
            padding: 20px;
            border-radius: 6px;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
            max-height: 400px;
            overflow-y: auto;
        }
        .param-row {
            margin: 8px 0;
            padding: 8px;
            background: rgba(255,255,255,0.05);
            border-radius: 4px;
        }
        .param-key {
            color: #42a5f5;
            font-weight: bold;
        }
        .param-value {
            color: #66bb6a;
            word-break: break-all;
        }
        .log-entry {
            margin: 5px 0;
            padding: 8px;
            border-radius: 4px;
            font-size: 12px;
        }
        .log-info { background: rgba(174, 213, 129, 0.1); color: #aed581; }
        .log-error { background: rgba(244, 67, 54, 0.1); color: #f44336; }
        .log-success { background: rgba(76, 175, 80, 0.1); color: #4caf50; }
        .input-group {
            margin: 15px 0;
        }
        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }
        .input-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }
        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ” æ”¯ä»˜æ¥å£è°ƒè¯•å·¥å…·</h1>
            <p>Linux.do Credit æ”¯ä»˜é›†æˆæµ‹è¯• | å®æ—¶ç­¾åéªŒè¯</p>
        </div>

        <div class="content">
            <div class="info-box">
                <strong>ğŸ’¡ ä½¿ç”¨è¯´æ˜ï¼š</strong><br>
                1. è¾“å…¥æµ‹è¯•é‡‘é¢å’Œç•™è¨€<br>
                2. ç‚¹å‡»"åˆ›å»ºæµ‹è¯•è®¢å•"æŸ¥çœ‹ç­¾åå‚æ•°<br>
                3. ç‚¹å‡»"æäº¤æ”¯ä»˜"æµ‹è¯•å®é™…çš„æ”¯ä»˜æµç¨‹<br>
                4. æŸ¥çœ‹è°ƒè¯•æ—¥å¿—äº†è§£è¯¦ç»†è¿‡ç¨‹
            </div>

            <div class="section">
                <h3>ğŸ“ æµ‹è¯•å‚æ•°</h3>
                <div class="input-group">
                    <label>æµ‹è¯•é‡‘é¢ï¼ˆå…ƒï¼‰</label>
                    <input type="number" id="testAmount" value="0.01" step="0.01" min="0.01" max="9999.99">
                </div>
                <div class="input-group">
                    <label>æµ‹è¯•ç•™è¨€</label>
                    <input type="text" id="testMessage" value="Debug Test" maxlength="50">
                </div>
                <div class="btn-group">
                    <button onclick="createOrder()">ğŸš€ åˆ›å»ºæµ‹è¯•è®¢å•</button>
                    <button onclick="clearLog()">ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—</button>
                </div>
                <div id="orderResult" style="margin-top: 15px;"></div>
            </div>

            <div class="section" id="paramsSection" style="display: none;">
                <h3>ğŸ” ç­¾åå‚æ•°è¯¦æƒ…</h3>
                <div id="paramsDisplay"></div>
            </div>

            <div class="section" id="submitSection" style="display: none;">
                <h3>ğŸ“¤ æäº¤æ”¯ä»˜è¯·æ±‚</h3>
                <div class="warning-box">
                    <strong>âš ï¸ æ³¨æ„ï¼š</strong><br>
                    ç‚¹å‡»æäº¤åå°†è·³è½¬åˆ° Linux.do Credit æ”¯ä»˜é¡µé¢ã€‚<br>
                    å¦‚æœçœ‹åˆ°"ç­¾åéªŒè¯å¤±è´¥"é”™è¯¯ï¼Œè¯´æ˜é…ç½®æœ‰é—®é¢˜ã€‚
                </div>
                <button onclick="submitPayment()">âœ… æäº¤åˆ° Linux.do Credit</button>
            </div>

            <div class="section">
                <h3>ğŸ“Š è°ƒè¯•æ—¥å¿—</h3>
                <div id="debugLog" class="code-block">
                    <div class="log-info">ç­‰å¾…æ“ä½œ...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = './api';
        let currentOrderData = null;

        function log(message, type = 'info') {
            const logDiv = document.getElementById('debugLog');
            const time = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'log-error' : type === 'success' ? 'log-success' : 'log-info';
            const icon = type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : 'â„¹ï¸';

            const entry = document.createElement('div');
            entry.className = `log-entry ${className}`;
            entry.textContent = `[${time}] ${icon} ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('debugLog').innerHTML = '<div class="log-info">æ—¥å¿—å·²æ¸…ç©º</div>';
            log('æ—¥å¿—å·²é‡ç½®');
        }

        async function createOrder() {
            const amount = parseFloat(document.getElementById('testAmount').value);
            const message = document.getElementById('testMessage').value;

            if (amount < 0.01 || amount > 9999.99) {
                alert('é‡‘é¢å¿…é¡»åœ¨ 0.01 åˆ° 9999.99 ä¹‹é—´');
                return;
            }

            log(`å¼€å§‹åˆ›å»ºæµ‹è¯•è®¢å• - é‡‘é¢: ${amount}å…ƒ`);

            try {
                const response = await fetch(`${API_BASE_URL}/create_order.php`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ amount, message })
                });

                const result = await response.json();
                log('æœåŠ¡å™¨å“åº”: ' + JSON.stringify(result, null, 2));

                if (result.code === 200) {
                    currentOrderData = result.data;

                    document.getElementById('orderResult').innerHTML =
                        '<div class="success-box"><strong>âœ… è®¢å•åˆ›å»ºæˆåŠŸ</strong><br>' +
                        'è®¢å•å·: <code>' + result.data.order_no + '</code></div>';

                    displayParams(result.data.pay_params);
                    document.getElementById('paramsSection').style.display = 'block';
                    document.getElementById('submitSection').style.display = 'block';

                    log('è®¢å•å·: ' + result.data.order_no, 'success');
                    log('ç­¾åå·²ç”Ÿæˆï¼Œè¯·æŸ¥çœ‹å‚æ•°è¯¦æƒ…', 'success');
                } else {
                    document.getElementById('orderResult').innerHTML =
                        '<div class="error-box"><strong>âŒ åˆ›å»ºå¤±è´¥</strong><br>' +
                        result.message + '</div>';
                    log('åˆ›å»ºè®¢å•å¤±è´¥: ' + result.message, 'error');
                }
            } catch (error) {
                log('è¯·æ±‚å¤±è´¥: ' + error.message, 'error');
                document.getElementById('orderResult').innerHTML =
                    '<div class="error-box"><strong>âŒ ç½‘ç»œé”™è¯¯</strong><br>' +
                    error.message + '</div>';
            }
        }

        function displayParams(params) {
            let html = '<div class="code-block">';

            // æ˜¾ç¤ºæ‰€æœ‰å‚æ•°
            html += '<div style="color: #ffeb3b; margin-bottom: 10px;">ğŸ“¦ è¯·æ±‚å‚æ•°ï¼š</div>';
            for (const [key, value] of Object.entries(params)) {
                html += `<div class="param-row">
                    <span class="param-key">${key}</span>:
                    <span class="param-value">${value}</span>
                </div>`;
            }

            // é‡å»ºç­¾åå­—ç¬¦ä¸²
            const sortedKeys = Object.keys(params)
                .filter(k => k !== 'sign' && k !== 'sign_type')
                .sort();
            const signString = sortedKeys.map(k => `${k}=${params[k]}`).join('&');

            html += '<br><div style="color: #ffeb3b;">ğŸ” å¾…ç­¾åå­—ç¬¦ä¸²ï¼š</div>';
            html += '<div style="color: #fff; word-break: break-all; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 4px;">' +
                    signString + '</div>';
            html += '<br><div style="color: #ffeb3b;">âœ”ï¸ MD5 ç­¾åï¼š</div>';
            html += '<div style="color: #66bb6a; font-weight: bold; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 4px;">' +
                    params.sign + '</div>';
            html += '</div>';

            document.getElementById('paramsDisplay').innerHTML = html;
            log('ç­¾åå‚æ•°å·²æ˜¾ç¤º');
        }

        function submitPayment() {
            if (!currentOrderData) {
                alert('è¯·å…ˆåˆ›å»ºè®¢å•');
                return;
            }

            log('å‡†å¤‡æäº¤æ”¯ä»˜è¯·æ±‚...');
            log('ç›®æ ‡: ' + currentOrderData.pay_url, 'success');

            // åˆ›å»ºè¡¨å•
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = currentOrderData.pay_url;

            for (const [key, value] of Object.entries(currentOrderData.pay_params)) {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = key;
                input.value = value;
                form.appendChild(input);
            }

            document.body.appendChild(form);
            log('ğŸš€ æäº¤è¡¨å•ï¼Œå³å°†è·³è½¬...', 'success');
            form.submit();
        }

        // é¡µé¢åŠ è½½å®Œæˆ
        window.onload = function() {
            log('=== è°ƒè¯•å·¥å…·å·²å°±ç»ª ===', 'success');
            log('æ”¯ä»˜ç½‘å…³: https://credit.linux.do/epay');
        };
    </script>
</body>
</html>
