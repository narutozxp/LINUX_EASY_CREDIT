<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ”¯ä»˜æˆåŠŸ</title>
    <link rel="stylesheet" href="./assets/css/style.css">
    <script>
        (() => {
            try {
                const saved = localStorage.getItem('theme-preference');
                if (saved === 'light' || saved === 'dark') {
                    document.documentElement.dataset.theme = saved;
                }
            } catch (_) {}
        })();
    </script>
</head>
<body>
    <div class="container">
        <div class="reward-card fade-in">
            <button id="themeToggle" class="theme-toggle" type="button" aria-label="åˆ‡æ¢ä¸»é¢˜" title="åˆ‡æ¢ä¸»é¢˜">ğŸ–¥ï¸</button>

            <!-- åŠ è½½çŠ¶æ€ -->
            <div id="loadingState" class="loading-container">
                <div class="loading-spinner"></div>
                <div class="loading-text">æ­£åœ¨æŸ¥è¯¢æ”¯ä»˜ç»“æœ...</div>
            </div>

            <!-- æˆåŠŸçŠ¶æ€ -->
            <div id="successState" style="display: none;">
                <div class="status-icon success">âœ“</div>

                <div class="header">
                    <h1>æ”¯ä»˜æˆåŠŸ</h1>
                    <p>æ„Ÿè°¢æ‚¨çš„æ”¯æŒï¼Œæ‚¨çš„é¼“åŠ±æ˜¯æˆ‘ç»§ç»­åˆ›ä½œçš„åŠ¨åŠ›ï¼</p>
                </div>

                <div class="order-info">
                    <div class="order-item">
                        <span class="order-label">è®¢å•å·</span>
                        <span class="order-value" id="orderNo">-</span>
                    </div>
                    <div class="order-item">
                        <span class="order-label">æ”¯ä»˜é‡‘é¢</span>
                        <span class="order-value order-amount" id="orderAmount">LDC 0.00</span>
                    </div>
                    <div class="order-item">
                        <span class="order-label">æ”¯ä»˜æ—¶é—´</span>
                        <span class="order-value" id="payTime">-</span>
                    </div>
                    <div class="order-item" id="messageItem" style="display: none;">
                        <span class="order-label">æ‚¨çš„ç•™è¨€</span>
                        <span class="order-value" id="orderMessage">-</span>
                    </div>
                </div>

                <div class="button-group">
                    <button class="btn btn-primary" onclick="location.href='index.html'">
                        <span class="btn-text">ç»§ç»­æ”¯æŒ</span>
                    </button>
                </div>
            </div>

            <!-- å¾…æ”¯ä»˜çŠ¶æ€ -->
            <div id="pendingState" style="display: none;">
                <div class="status-icon pending">â³</div>

                <div class="header">
                    <h1>ç­‰å¾…æ”¯ä»˜</h1>
                    <p>è®¢å•å°šæœªå®Œæˆæ”¯ä»˜</p>
                </div>

                <div class="order-info">
                    <div class="order-item">
                        <span class="order-label">è®¢å•å·</span>
                        <span class="order-value" id="pendingOrderNo">-</span>
                    </div>
                    <div class="order-item">
                        <span class="order-label">è®¢å•é‡‘é¢</span>
                        <span class="order-value order-amount" id="pendingAmount">LDC 0.00</span>
                    </div>
                </div>

                <div class="button-group">
                    <button class="btn btn-primary" onclick="location.href='index.html'">
                        <span class="btn-text">è¿”å›é¦–é¡µ</span>
                    </button>
                </div>
            </div>
        </div>

        <div class="footer">
            <div class="footer-text">
                <span class="footer-icon">ğŸ”’</span>
                ç”± <a href="https://credit.linux.do" target="_blank">LINUX DO CREDIT</a> æä¾›å®‰å…¨è®¤è¯
            </div>
        </div>
    </div>

    <script src="./assets/js/theme.js"></script>
    <script>
        const API_BASE_URL = './api';

        // é¡µé¢åŠ è½½æ—¶æŸ¥è¯¢è®¢å•çŠ¶æ€
        document.addEventListener('DOMContentLoaded', function() {
            checkOrderStatus();
        });

        async function checkOrderStatus() {
            // ä» localStorage è·å–è®¢å•å·
            const orderNo = localStorage.getItem('current_order');

            if (!orderNo) {
                showPendingState();
                return;
            }

            try {
                // æŸ¥è¯¢è®¢å•çŠ¶æ€
                const response = await fetch(`${API_BASE_URL}/query_order.php?order_no=${orderNo}`);
                const result = await response.json();

                if (result.code === 200) {
                    const order = result.data;

                    if (order.status === 1) {
                        // æ”¯ä»˜æˆåŠŸ
                        showSuccessState(order);
                        // æ¸…é™¤è®¢å•å·
                        localStorage.removeItem('current_order');
                    } else {
                        // å¾…æ”¯ä»˜ï¼Œç»§ç»­è½®è¯¢
                        setTimeout(checkOrderStatus, 2000);
                    }
                } else {
                    showPendingState();
                }
            } catch (error) {
                console.error('æŸ¥è¯¢è®¢å•å¤±è´¥:', error);
                showPendingState();
            }
        }

        function showSuccessState(order) {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('successState').style.display = 'block';

            document.getElementById('orderNo').textContent = order.order_no;
            document.getElementById('orderAmount').textContent = `LDC ${parseFloat(order.amount).toFixed(2)}`;
            document.getElementById('payTime').textContent = order.pay_time || '-';

            if (order.message) {
                document.getElementById('messageItem').style.display = 'flex';
                document.getElementById('orderMessage').textContent = order.message;
            }
        }

        function showPendingState() {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('pendingState').style.display = 'block';

            const orderNo = localStorage.getItem('current_order');
            if (orderNo) {
                document.getElementById('pendingOrderNo').textContent = orderNo;
            }
        }
    </script>
</body>
</html>
